<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<model name="fire">
	<global>

		<!-- Environment parameters -->
		<var type="int" name="width" parameter="Width of the environment (in meters):" init="500" min="10"
			max="1000" category="Environment" />
		<var type="int" name="height" parameter="Height of the environment (in meters):" init="500"
			min="10" max="1000" category="Environment" />
		<var type="int" name="fires_number" parameter="Number of fire starting points:" init="10" min="0"
			category="Environment" />

		<!-- Tree parameters -->
		<var type="int" name="trees_number" parameter="Number of trees:" init="5000" min="1" category="Trees" />
		<var type="int" name="tree_burning_time" init="100"
			parameter="Number of steps taken by a tree to burn entirely:" category="Trees" />
		<var type="int" name="tree_propagating_time" init="35"
			parameter="Number of steps before a tree begins to propagate the fire:" category="Trees" />
		<var type="float" name="tree_max_size" parameter="Max. diameter of trees (in meters):" init="12 m"
			min="1 m" max="30 m" category="Trees" />
		<var type="float" name="tree_propagation_probability" init="0.7"
			parameter="Probability for each burning tree to propagate fire:" category="Trees" />
		<var type="int" name="tree_propagation_distance" init="6"
			parameter="Max. propagation distance for fire between trees (in meters):" category="Trees" />

		<!-- new tree parameter (model 4) -->
		<var type="int" name="tree_drying_time" init="100"
			parameter="Number of steps before a tree dries after having been watered:" category="Trees" />

		<!-- new fireman parameters (model 4) -->
		<var type="int" name="fireman_watering_range" init="3"
			parameter="Max. range of watering of firemen (in meters):" min="1" category="Firemen" />
		<var type="int" name="fireman_watering_distance" init="6"
			parameter="Distance to a fire at which firemen begin to water (in meters):" min="1" category="Firemen" />
		<var type="float" name="fireman_speed" parameter="Speed of firemen (in m/s):" init="3" min="0"
			category="Firemen" />
		<var type="int" name="firemen_number" parameter="Number of firemen:" init="8" min="0"
			category="Firemen" />
		<var type="rgb" name="fireman_color" parameter="Display color of firemen:" init="rgb [255,255,255]"
			category="Firemen" />


		<init>

			<create species="tree" number="trees_number" />
			<ask target="fires_number among (list tree)">
				<set name="state" value="'burning'" />
			</ask>

			<!-- new creation of firemen -->
			<create species="fireman" number="firemen_number" />

		</init>

	</global>

	<environment width="width" height="height" torus="false" />


	<entities>
		<species name="tree" skills="situated, visible" control="fsm">
			<var type="rgb" name="original_color" init="rgb [0, rnd 200 + 55, 0]" const="true" />
			<var type="rgb" name="color" init="original_color" />
			<var type="float" name="size" init="((rnd 100 / 100) * tree_max_size) + 1" const="true" />
			<var type="point" name="location" init="{rnd width, rnd height}" const="true" />
			<var type="float" name="range" init="tree_propagation_distance + (size / 2)" const="true" />
			<var type="int" name="own_max_burning_time" init="tree_burning_time - (tree_burning_time / size)"
				const="true" />

			<state name="intact" initial="true">
				<enter>
					<set name="color" value="original_color" />
				</enter>
			</state>

			<state name="burning">
				<enter>
					<let name="duration" value="0" />
				</enter>
				<set name="duration" value="duration + 1" />
				<set name="color" value="rgb [255,rnd 255, 0]" />
				<if condition="(duration > tree_propagating_time) and (flip tree_propagation_probability)">
					<ask target="(neighbours of_species tree) where (each.state = 'intact')">
						<set name="state" value="'burning'" />
					</ask>
				</if>
				<transition to="destroyed" when="duration >= own_max_burning_time" />
			</state>


			<state name="destroyed">
				<enter>
					<create species="dead_tree" number="1">
						<set name="location" value="myself.location" />
					</create>
				</enter>
				<do action="die" />
			</state>

			<!-- new state added to trees (model 4) -->
			<state name="protected">
				<enter>
					<let name="duration" value="0" />
					<set name="color" value="rgb [0, 0, 100 + rnd 155]" />
				</enter>
				<set name="duration" value="duration + 1" />
				<transition to="intact" when="duration >= tree_drying_time" />
			</state>

		</species>

		<species name="dead_tree" skills="situated,visible">
			<var type="rgb" name="color" value="rgb [rnd 100,rnd 30, rnd 30]" const="true" />
			<var type="float" name="size" value="3" const="true" />
		</species>

		<!-- new species of agents (model 4). Notice the use of the "moving" skill -->
		<species name="fireman" skills="visible, moving">

			<var type="rgb" name="color" init="fireman_color" const="true" />
			<var type="float" name="range" value="fireman_watering_distance" />
			<var type="float" name="size" init="4" const="true" />
			<var type="point" name="location" init="{(rnd 1000 / 1000) * width, (rnd 1000 / 1000) * height}" />

			<!-- redefinition of the built-in attribute "speed" introduced by "moving" -->
			<var type="float" name="speed" value="fireman_speed" />

			<!-- new definition of a "reflex" for firemen (model 4) -->
			<reflex name="patrolling">

				<!-- notice the usage of the built-in action "wander" introduced by "moving" -->
				<do action="wander">

					<!-- notice how to pass arguments to actions -->
					<arg name="amplitude" value="180" />
				</do>
				<let name="burning_neighbours" value="(neighbours of_species tree) where (each.state = 'burning')" />
				<if condition="! empty burning_neighbours">

					<!-- notice the use of "neighbours_at" to complement the built-in "neighbours" -->
					<ask target="((self neighbours_at fireman_watering_range) of_species tree)">
						<set name="state" value="'protected'" />
					</ask>
				</if>
			</reflex>

		</species>

	</entities>

	<output>

		<display name="Forest" >
			<image name="background" file="'../images/soil.jpg'"/>
			<species name="dead_tree" />
			<species name="tree" transparency="0.2" />
			<species name="fireman" />
		</display>

		<!-- notice the new definition of a series pie covering the states of the trees  -->
		<chart type="series" name="State of trees" refresh_every="20">
			<!--
				<data name="watered" value="list tree count (each.state = 'protected')" color="rgb 'blue'"
				style="step"/>
			-->
			<data name="burning" value="list tree count (each.state = 'burning')" color="rgb 'red'"
				style="step" />
			<data name="destroyed" value="int dead_tree" color="rgb [100, 10, 10]" style="line" />
			<!--
				<data name="intact" value="list tree count (each.state = 'intact')" color="rgb 'blue'"
				style="spline"/>
			-->
		</chart>

		<chart type="pie" name="Distribution of sizes" style="exploded" refresh_every="1">
			<data name="under 4m" value="list tree count (each.size &lt;= 4)" />
			<data name="between 4 - 7m" value="list tree count (each.size &gt; 4) and (each.size &lt;= 7)" />
			<data name="above 7m" value="list tree count (each.size &gt; 7)" />
		</chart>

		<monitor name="% burnt" value=" string int ((int dead_tree / trees_number) * 100) + '%'" />

		<monitor name="Time" value="time" />

		<inspect name="Agents" type="agent" />

		<inspect name="Species" type="species" />
	</output>
</model>